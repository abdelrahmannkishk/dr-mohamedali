<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„ÙƒÙŠÙ†Ø¬ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ | THE KING ELITE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root { --gold-red: #dc2626; --dark-blue: #0f172a; }
        * { font-family: 'Cairo', sans-serif; box-sizing: border-box; }
        body { background: #fdfdfd; color: var(--dark-blue); overflow-x: hidden; }
        .sec { display: none; padding-bottom: 120px; animation: fadeIn 0.4s ease; }
        .sec.active { display: block; }
        .royal-card { background: white; border-radius: 35px; border: 1px solid #f1f5f9; box-shadow: 0 15px 35px rgba(0,0,0,0.03); }
        .btn-main { background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%); color: white; border-radius: 20px; font-weight: 900; transition: 0.3s; }
        .nav-item { color: #94a3b8; transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: #dc2626; }
        .locked { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #scoreModal { display: none; background: rgba(0,0,0,0.8); backdrop-blur: 5px; }
        #quizTimer { position: fixed; top: 20px; left: 20px; background: #dc2626; color: white; padding: 10px 20px; border-radius: 15px; font-weight: 900; z-index: 100; box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4); }
        
        /* Watermark Style - Updated to RED */
        #videoWrapper { position: relative; width: 100%; border-radius: 40px; overflow: hidden; background: #000; }
        #videoWatermark {
            position: absolute;
            z-index: 9999;
            color: #ff0000; /* Red Color */
            font-weight: 900;
            pointer-events: none;
            font-size: 16px;
            white-space: nowrap;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            transition: all 1.2s linear;
            opacity: 0.8;
        }
    </style>
</head>
<body>

    <div id="quizTimer" class="hidden">00:00</div>

    <div id="scoreModal" class="fixed inset-0 z-[2000000] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[40px] p-10 text-center animate__animated animate__bounceIn">
            <div id="scoreIcon" class="text-6xl mb-4">ğŸ†</div>
            <h2 class="text-2xl font-black mb-2">Ù†ØªÙŠØ¬ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <div id="scoreValue" class="text-5xl font-black text-red-600 mb-6">0%</div>
            <button onclick="document.getElementById('scoreModal').style.display='none'; document.getElementById('quizTimer').classList.add('hidden');" class="w-full btn-main py-4">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
        </div>
    </div>

    <div id="authScreen" class="fixed inset-0 z-[999999] bg-white flex items-center justify-center p-4">
        <div class="w-full max-w-md royal-card p-10 text-center animate__animated animate__zoomIn">
            <div class="w-20 h-20 bg-red-600 text-white rounded-3xl flex items-center justify-center text-4xl mx-auto mb-6 shadow-xl"><i class="fas fa-crown"></i></div>
            <h1 class="text-2xl font-black mb-6">Ù…Ù†ØµØ© Ø§Ù„ÙƒÙŠÙ†Ø¬ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</h1>
            <div class="flex gap-2 mb-8 bg-slate-100 p-1 rounded-2xl">
                <button onclick="toggleAuth('login')" id="tabL" class="flex-1 py-3 rounded-xl font-black bg-white shadow-sm">Ø¯Ø®ÙˆÙ„</button>
                <button onclick="toggleAuth('reg')" id="tabR" class="flex-1 py-3 rounded-xl font-black text-slate-400">Ø¬Ø¯ÙŠØ¯</button>
            </div>
            <div id="authForms" class="space-y-4">
                <div id="lForm">
                    <input type="tel" id="lPh" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" class="w-full p-4 bg-slate-50 rounded-2xl mb-4 text-center font-bold outline-none">
                    <input type="password" id="lPs" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-4 bg-slate-50 rounded-2xl mb-6 text-center font-bold outline-none">
                    <button onclick="handleLogin()" class="w-full btn-main py-5 text-xl">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒÙŠÙ†Ø¬ ğŸš€</button>
                </div>
                <div id="rForm" class="hidden">
                    <input type="text" id="rN" placeholder="Ø§Ù„Ø§Ø³Ù…" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 text-center font-bold outline-none">
                    <input type="tel" id="rPh" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 text-center font-bold outline-none">
                    <input type="password" id="rPs" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 text-center font-bold outline-none">
                    <select id="rLv" class="w-full p-4 bg-slate-50 rounded-2xl mb-6 text-center font-black outline-none"><option value="1">1Ø«</option><option value="2">2Ø«</option><option value="3">3Ø«</option></select>
                    <button onclick="handleRegister()" class="w-full btn-main py-5 text-xl">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ âœ¨</button>
                </div>
            </div>
        </div>
    </div>

    <header id="mainHeader" class="sticky top-0 z-[50000] bg-white/90 backdrop-blur-md border-b p-4 hidden">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-red-600 text-white rounded-xl flex items-center justify-center text-xl font-black">M</div>
                <h1 class="text-xl font-black italic">EL-KING <span class="text-red-600">MOHAMED ALI</span></h1>
            </div>
            <button onclick="logout()" class="w-10 h-10 bg-slate-50 text-slate-400 rounded-xl flex items-center justify-center"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        <div id="homeSec" class="sec active space-y-8">
            <h2 class="text-3xl font-black italic border-r-8 border-red-600 pr-4">ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„ÙƒÙŠÙ†Ø¬ Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
            <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <div id="walletSec" class="sec space-y-8">
            <div class="royal-card p-10 bg-slate-900 text-white flex flex-col md:flex-row justify-between items-center gap-8 relative overflow-hidden">
                <div class="z-10"><h3 id="dName" class="text-4xl font-black mb-2">...</h3><p id="dLevel" class="text-red-500 font-black"></p></div>
                <div class="z-10 bg-white/10 p-8 rounded-[40px] text-center min-w-[200px]"><span class="block text-xs font-black opacity-60 mb-2">Ø±ØµÙŠØ¯Ùƒ</span><span id="dBal" class="text-5xl font-black text-yellow-400">0 <small class="text-sm">Ø¬.Ù…</small></span></div>
            </div>
            <div class="royal-card p-10 text-center">
                <input type="text" id="cInp" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" class="w-full p-5 bg-slate-50 border-4 border-dashed rounded-[30px] text-center text-3xl font-black mb-6 outline-none">
                <button onclick="useCode()" class="w-full btn-main py-6 text-2xl mb-4">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¢Ù† âš¡</button>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <a href="https://wa.me/201550908118" target="_blank" class="p-4 bg-green-100 text-green-700 rounded-2xl font-black flex items-center justify-center gap-2"><i class="fab fa-whatsapp"></i> Ø·Ù„Ø¨ ÙƒÙˆØ¯</a>
                    <a href="https://wa.me/201550908118" target="_blank" class="p-4 bg-blue-100 text-blue-700 rounded-2xl font-black flex items-center justify-center gap-2"><i class="fas fa-headset"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a>
                </div>
            </div>
        </div>

        <div id="ranksSec" class="sec space-y-8">
            <div id="ranksList" class="space-y-12 max-w-3xl mx-auto"></div>
        </div>

        <div id="forumSec" class="sec space-y-4">
            <div id="chatBox" class="h-[60vh] overflow-y-auto bg-white rounded-[40px] p-8 border-2 flex flex-col gap-4"></div>
            <div class="bg-white p-3 rounded-[30px] shadow-2xl border flex gap-3"><input type="text" id="msgInp" placeholder="Ø§Ø³Ø£Ù„ Ø§Ù„ÙƒÙŠÙ†Ø¬..." class="flex-1 px-6 outline-none"><button onclick="sendMsg()" class="w-16 h-16 btn-main rounded-2xl flex items-center justify-center"><i class="fas fa-paper-plane"></i></button></div>
        </div>

        <div id="lessonsSec" class="sec space-y-6">
            <button onclick="showSection('home')" class="bg-white px-8 py-3 rounded-2xl font-black shadow-md border">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            
            <div id="videoArea" class="hidden">
                <div id="videoWrapper" class="shadow-2xl border-8 border-white relative">
                    <div id="videoWatermark"></div>
                    
                    <div class="relative pt-[56.25%]">
                        <iframe id="mainIframe" class="absolute inset-0 w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="no-referrer"></iframe>
                    </div>
                </div>
            </div>

            <div id="lessonsList" class="grid gap-4"></div>
            <div id="quizContainer" class="hidden bg-white p-8 royal-card"></div>
        </div>
    </main>

    <div id="adminPanel" class="fixed inset-0 bg-white hidden z-[1000000] flex flex-col no-print">
        <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
            <h2 class="text-2xl font-black uppercase italic">The King Control</h2>
            <button onclick="closeAdmin()" class="bg-red-600 px-8 py-3 rounded-2xl font-black">Ø®Ø±ÙˆØ¬</button>
        </div>
        <div class="flex-1 flex overflow-hidden">
            <aside class="w-64 bg-slate-50 p-6 flex flex-col gap-2 border-l overflow-y-auto">
                <button onclick="admTab('ch')" class="w-full p-4 bg-white rounded-xl text-right font-black border">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</button>
                <button onclick="admTab('le')" class="w-full p-4 bg-white rounded-xl text-right font-black border">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</button>
                <button onclick="admTab('qu')" class="w-full p-4 bg-white rounded-xl text-right font-black border">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
                <button onclick="admTab('st')" class="w-full p-4 bg-white rounded-xl text-right font-black border text-red-600">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ğŸ‘¤</button>
                <button onclick="admTab('qs')" class="w-full p-4 bg-white rounded-xl text-right font-black border text-blue-600">Ø£ÙˆØ§Ø¦Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
                <button onclick="admTab('fm')" class="w-full p-4 bg-white rounded-xl text-right font-black border text-purple-600">ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù†ØªØ¯Ù‰</button>
                <button onclick="admTab('co')" class="w-full p-4 bg-white rounded-xl text-right font-black border text-yellow-600">ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯</button>
            </aside>
            <main id="admBody" class="flex-1 p-12 overflow-y-auto"></main>
        </div>
    </div>

    <nav id="bottomNav" class="fixed bottom-6 inset-x-6 h-20 bg-white/90 backdrop-blur-xl rounded-full shadow-2xl border flex justify-around items-center hidden z-[40000]">
        <div onclick="showSection('home')" class="nav-item active" id="navHome"><i class="fas fa-th-large text-xl"></i><span class="text-[9px] font-black">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div onclick="showSection('ranks')" class="nav-item" id="navRanks"><i class="fas fa-trophy text-xl"></i><span class="text-[9px] font-black">Ø§Ù„Ù…ØªÙˆÙÙ‚ÙŠÙ†</span></div>
        <div onclick="showSection('forum')" class="nav-item" id="navForum"><i class="fas fa-comment-dots text-xl"></i><span class="text-[9px] font-black">Ø§Ù„Ù…Ù†ØªØ¯Ù‰</span></div>
        <div onclick="showSection('wallet')" class="nav-item" id="navWallet"><i class="fas fa-user-circle text-xl"></i><span class="text-[9px] font-black">Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ</span></div>
        <button id="admQuick" onclick="openAdmin()" class="hidden w-12 h-12 bg-red-600 text-white rounded-full"><i class="fas fa-user-shield"></i></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const config = { apiKey: "AIzaSyDpmP1ZRW0o4qAHwPQaaxdFZxHopJsNhAQ", authDomain: "zoomclean-29d20.firebaseapp.com", databaseURL: "https://zoomclean-29d20-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "zoomclean-29d20" };
        const app = initializeApp(config); const db = getDatabase(app);
        window.db = db; window.ref = ref; window.set = set; window.onValue = onValue; window.get = get; window.update = update; window.push = push; window.remove = remove;
        initApp();
    </script>

    <script>
        let user = null; let dbData = {}; let tempImg = ""; let editingQId = null; let quizInt = null; let wmInterval = null;

        function toggleAuth(t){ document.getElementById('lForm').classList.toggle('hidden', t==='reg'); document.getElementById('rForm').classList.toggle('hidden', t==='login'); }
        async function handleLogin() {
            const ph = document.getElementById('lPh').value.trim(); const ps = document.getElementById('lPs').value.trim();
            if(ph === "01550908118" && ps === "22574") { user = { name: "Ø§Ù„ÙƒÙŠÙ†Ø¬ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ", phone: ph, role: 'admin', level: 'ALL', balance: 999999 }; localStorage.setItem('golden_user', JSON.stringify(user)); location.reload(); }
            else { const snap = await window.get(window.ref(window.db, 'academy/students/'+ph)); if(snap.exists() && snap.val().pass === ps) { user = snap.val(); localStorage.setItem('golden_user', JSON.stringify(user)); location.reload(); } else alert("Ø®Ø·Ø£!"); }
        }
        async function handleRegister() {
            const ph = document.getElementById('rPh').value.trim();
            const u = { name: document.getElementById('rN').value, phone: ph, pass: document.getElementById('rPs').value, level: document.getElementById('rLv').value, balance: 0, role: 'student' };
            await window.set(window.ref(window.db, 'academy/students/'+ph), u); alert("ØªÙ…!"); toggleAuth('login');
        }

        function initApp() {
            const saved = localStorage.getItem('golden_user');
            if(saved) {
                user = JSON.parse(saved); document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainHeader').classList.remove('hidden'); document.getElementById('bottomNav').classList.remove('hidden');
                if(user.role === 'admin') document.getElementById('admQuick').classList.remove('hidden');
                window.onValue(window.ref(window.db, 'academy'), snap => {
                    dbData = snap.val() || {}; renderCourses(); renderForum(); renderRanks();
                    if(user.role !== 'admin' && dbData.students?.[user.phone]) { user = dbData.students[user.phone]; document.getElementById('dBal').innerText = user.balance + " Ø¬.Ù…"; }
                });
            }
        }

        function renderCourses() {
            const grid = document.getElementById('coursesGrid');
            const chs = Object.values(dbData.chapters || {}).filter(c => user.role === 'admin' || c.level === user.level);
            grid.innerHTML = chs.map(ch => `
                <div class="royal-card p-6 text-center">
                    <img src="${ch.img || ''}" class="w-full h-40 object-cover rounded-2xl mb-4 border">
                    <h4 class="text-xl font-black mb-4">${ch.title}</h4>
                    <div class="flex gap-2">
                        <button onclick="openChapter('${ch.id}')" class="flex-1 bg-slate-100 py-3 rounded-xl font-black text-xs">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
                        ${(user.role === 'admin' || (user.courses && user.courses[ch.id])) ? '<div class="flex-1 text-green-600 font-black">Ù…ØªØ§Ø­ âœ…</div>' : `<button onclick="buyCourse('${ch.id}', ${ch.price})" class="flex-1 btn-main py-3 text-xs">${ch.price} Ø¬.Ù…</button>`}
                    </div>
                </div>`).join('');
        }

        window.openChapter = (id) => {
            if(user.role !== 'admin' && !(user.courses && user.courses[id])) return alert("Ø§Ø´ØªØ±Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");
            const lecs = Object.values(dbData.lectures || {}).filter(l => l.chId === id).sort((a,b) => a.id.localeCompare(b.id));
            let results = dbData.quizResults ? Object.values(dbData.quizResults).filter(r => r.phone === user.phone) : [];
            document.getElementById('lessonsList').innerHTML = lecs.map((l, idx) => {
                const qCount = Object.values(dbData.questions || {}).filter(q => q.lecId === l.id).length;
                const prevPassed = idx === 0 || results.some(r => r.lecId === lecs[idx-1].id && r.score >= 50);
                const isLocked = !prevPassed && user.role !== 'admin';
                return `<div class="bg-white p-5 rounded-3xl shadow-sm border flex justify-between items-center ${isLocked ? 'locked' : ''}">
                    <span class="font-black text-lg">${isLocked ? 'ğŸ”’ ' : ''}${l.title}</span>
                    <div class="flex gap-2">
                        <button onclick="${isLocked ? '' : `playVideo('${l.url}')`}" class="btn-main px-6 py-2 text-xs">ÙÙŠØ¯ÙŠÙˆ</button>
                        ${qCount > 0 ? `<button onclick="${isLocked ? '' : `startQuiz('${l.id}')`}" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-xs font-black">Ø§Ù…ØªØ­Ù†</button>` : ''}
                    </div>
                </div>`;
            }).join('');
            showSection('lessons');
        };

        // Ultimate Video Fix & Red Watermark
        window.playVideo = (url) => {
            const area = document.getElementById('videoArea');
            const iframe = document.getElementById('mainIframe');
            area.classList.remove('hidden');

            let videoID = "";
            // Handle various youtube link formats
            if(url.includes('embed/')) videoID = url.split('embed/')[1].split('?')[0];
            else if(url.includes('v=')) videoID = url.split('v=')[1].split('&')[0];
            else if(url.includes('youtu.be/')) videoID = url.split('youtu.be/')[1].split('?')[0];
            else videoID = url.trim();

            // Set source with minimal controls to avoid issues
            iframe.src = `https://www.youtube.com/embed/${videoID}?autoplay=1&rel=0&showinfo=0&modestbranding=1`;

            // Start Secure Red Watermark
            const wm = document.getElementById('videoWatermark');
            wm.innerText = `${user.name} | ${user.phone}`;
            
            if(wmInterval) clearInterval(wmInterval);
            const moveWM = () => {
                const x = Math.random() * 60 + 5; // keep inside video frame
                const y = Math.random() * 70 + 10;
                wm.style.left = x + "%";
                wm.style.top = y + "%";
            };
            moveWM();
            wmInterval = setInterval(moveWM, 3000); // Faster movement for security

            window.scrollTo(0,0);
        };

        window.startQuiz = (id) => {
            const qs = Object.values(dbData.questions || {}).filter(q => q.lecId === id);
            const firstQ = qs[0];
            const hasTaken = Object.values(dbData.quizResults || {}).find(r => r.phone === user.phone && r.lecId === id);
            
            if(firstQ?.oneTime && hasTaken && user.role !== 'admin') {
                alert(`Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·. Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: ${hasTaken.score}%`);
                return;
            }

            const container = document.getElementById('quizContainer'); container.classList.remove('hidden');
            container.innerHTML = `<h3 class="text-2xl font-black mb-6">Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¯Ø±Ø³</h3>` + qs.map((q, i) => `<div class="mb-8 p-6 bg-slate-50 rounded-2xl"><p class="font-black text-xl mb-4">${i+1}. ${q.text}</p><div class="grid gap-3">${[q.a, q.b, q.c, q.d].map((opt, idx) => `<button onclick="ansQuiz(this, '${q.id}', ${idx})" class="w-full p-4 bg-white border-2 rounded-xl font-bold text-right">${opt}</button>`).join('')}</div></div>`).join('') + `<button onclick="submitQuiz('${id}')" class="w-full btn-main py-4 text-xl">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>`;

            if(firstQ?.timer > 0) {
                let time = firstQ.timer * 60;
                const timerEl = document.getElementById('quizTimer');
                timerEl.classList.remove('hidden');
                clearInterval(quizInt);
                quizInt = setInterval(() => {
                    let m = Math.floor(time/60); let s = time%60;
                    timerEl.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                    if(time <= 0) { clearInterval(quizInt); submitQuiz(id); alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!"); }
                    time--;
                }, 1000);
            }
        };

        window.ansQuiz = (b, qId, idx) => { b.parentElement.querySelectorAll('button').forEach(x => x.classList.remove('bg-red-600', 'text-white')); b.classList.add('bg-red-600', 'text-white'); if(!window.curA) window.curA = {}; window.curA[qId] = idx; };
        
        window.submitQuiz = async (id) => {
            clearInterval(quizInt);
            const qs = Object.values(dbData.questions || {}).filter(q => q.lecId === id);
            let s = 0; qs.forEach(q => { if(window.curA?.[q.id] == q.correct) s++; });
            const f = Math.round((s/qs.length)*100);
            await window.push(window.ref(window.db, 'academy/quizResults'), { student: user.name, phone: user.phone, lecId: id, lecTitle: dbData.lectures[id]?.title || 'Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³ØªÙ‚Ù„', score: f, time: Date.now() });
            document.getElementById('scoreValue').innerText = f + "%"; document.getElementById('scoreModal').style.display = "flex"; document.getElementById('quizContainer').classList.add('hidden');
            window.curA = {};
        };

        window.admTab = (t) => {
            const b = document.getElementById('admBody'); const s = "w-full p-4 bg-slate-50 border rounded-xl mb-3 font-bold";
            if(t === 'ch') {
                b.innerHTML = `<h3 class="text-2xl font-black mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h3><input id="at" placeholder="Ø§Ù„Ø§Ø³Ù…" class="${s}"><input id="ap" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="${s}"><select id="al" class="${s}"><option value="1">1Ø«</option><option value="2">2Ø«</option><option value="3">3Ø«</option></select><input type="file" onchange="upImg(this)" class="${s}"><button onclick="svCh()" class="w-full btn-main py-4">Ø­ÙØ¸</button><div class="mt-8 space-y-2">${Object.values(dbData.chapters||{}).map(c=>`<div class="p-3 border rounded-xl flex justify-between"><span>${c.title}</span><button onclick="delItem('chapters','${c.id}')" class="text-red-600">Ø­Ø°Ù ğŸ—‘ï¸</button></div>`).join('')}</div>`;
            }
            if(t === 'le') {
                b.innerHTML = `<h3 class="text-2xl font-black mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h3><select id="lch" class="${s}">${Object.values(dbData.chapters||{}).map(c=>`<option value="${c.id}">${c.title}</option>`).join('')}</select><input id="lt" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="${s}"><input id="lu" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ" class="${s}"><button onclick="svLe()" class="w-full btn-main py-4">Ø±ÙØ¹</button><div class="mt-8 space-y-2">${Object.values(dbData.lectures||{}).map(l=>`<div class="p-3 border rounded-xl flex justify-between"><span>${l.title}</span><button onclick="delItem('lectures','${l.id}')" class="text-red-600">Ø­Ø°Ù ğŸ—‘ï¸</button></div>`).join('')}</div>`;
            }
            if(t === 'st') {
                b.innerHTML = `<h3 class="text-2xl font-black mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3><div class="space-y-4">${Object.values(dbData.students || {}).map(st => `<div class="p-4 bg-white border rounded-2xl flex flex-wrap justify-between items-center gap-4"><div class="font-black text-sm">ğŸ‘¤ ${st.name} <br> <span class="text-xs text-slate-400">ğŸ“± ${st.phone} | ğŸ’° ${st.balance} Ø¬.Ù…</span></div><div class="flex gap-2"><input type="number" id="bal_${st.phone}" placeholder="+ Ø±ØµÙŠØ¯" class="w-24 p-2 border rounded-xl text-xs"><button onclick="addBalMan('${st.phone}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-xs font-bold italic">Ø´Ø­Ù†</button></div></div>`).join('')}</div>`;
            }
            if(t === 'qu') {
                editingQId = null;
                b.innerHTML = `<h3 class="text-2xl font-black mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ®ØµØ§Ø¦Øµ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h3>
                <div class="bg-slate-100 p-6 rounded-3xl mb-10">
                    <select id="qLec" class="${s}"><option value="none">Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³ØªÙ‚Ù„</option>${Object.values(dbData.lectures||{}).map(l=>`<option value="${l.id}">${l.title}</option>`).join('')}</select>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div><label class="text-xs font-black">ÙˆÙ‚Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label><input id="qTime" type="number" value="30" class="${s}"></div>
                        <div><label class="text-xs font-black">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</label><select id="qOnce" class="${s}"><option value="0">ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</option><option value="1">Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·</option></select></div>
                    </div>
                    <input id="qT" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" class="${s}">
                    <div class="grid grid-cols-2 gap-2"><input id="qa" placeholder="Ø®ÙŠØ§Ø± 1" class="${s}"><input id="qb" placeholder="Ø®ÙŠØ§Ø± 2" class="${s}"><input id="qc" placeholder="Ø®ÙŠØ§Ø± 3" class="${s}"><input id="qd" placeholder="Ø®ÙŠØ§Ø± 4" class="${s}"></div>
                    <select id="qC" class="${s}"><option value="0">Ø®ÙŠØ§Ø± 1 ØµØ­</option><option value="1">Ø®ÙŠØ§Ø± 2 ØµØ­</option><option value="2">Ø®ÙŠØ§Ø± 3 ØµØ­</option><option value="3">Ø®ÙŠØ§Ø± 4 ØµØ­</option></select>
                    <button id="qBtn" onclick="svQu()" class="w-full btn-main py-4 italic uppercase">Save Question & Settings</button>
                </div>
                <div class="space-y-3">${Object.values(dbData.questions||{}).map(q => `<div class="p-4 border rounded-2xl flex justify-between bg-white shadow-sm font-bold"><span>${q.text}</span><div class="flex gap-2"><button onclick="editQ('${q.id}')" class="text-blue-600">ØªØ¹Ø¯ÙŠÙ„</button><button onclick="delItem('questions','${q.id}')" class="text-red-600">Ø­Ø°Ù</button></div></div>`).join('')}</div>`;
            }
            if(t === 'qs') {
                b.innerHTML = `<h3 class="text-2xl font-black mb-6">Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h3><select onchange="showLecRanks(this.value)" class="${s}"><option>Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</option>${Object.values(dbData.lectures||{}).map(l=>`<option value="${l.id}">${l.title}</option>`).join('')}</select><div id="lecRanksBox" class="space-y-2 mt-4"></div>`;
            }
            if(t === 'fm') { b.innerHTML = `<h3 class="text-2xl font-black mb-6">ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù†ØªØ¯Ù‰</h3><div class="space-y-2">${Object.entries(dbData.chats||{}).map(([id, m])=>`<div class="p-3 border rounded-xl flex justify-between"><span><b>${m.name}:</b> ${m.text}</span><button onclick="delItem('chats','${id}')" class="text-red-600">Ø­Ø°Ù</button></div>`).join('')}</div>`; }
            if(t === 'co') { b.innerHTML = `<input id="camt" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©" class="${s}"><input id="ccnt" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" class="${s}"><button onclick="genTurbo()" class="w-full btn-main py-4">ØªÙˆÙ„ÙŠØ¯</button><div id="pFill"></div>`; }
        };

        window.addBalMan = async (ph) => { const val = parseInt(document.getElementById('bal_'+ph).value); if(!val) return; const currentBal = dbData.students[ph].balance || 0; await window.update(window.ref(window.db, 'academy/students/'+ph), { balance: currentBal + val }); alert("ØªÙ… Ø§Ù„Ø´Ø­Ù†! ğŸ’°"); admTab('st'); };
        window.editQ = (id) => { editingQId = id; const q = dbData.questions[id]; document.getElementById('qLec').value = q.lecId; document.getElementById('qT').value = q.text; document.getElementById('qa').value = q.a; document.getElementById('qb').value = q.b; document.getElementById('qc').value = q.c; document.getElementById('qd').value = q.d; document.getElementById('qC').value = q.correct; document.getElementById('qTime').value = q.timer || 30; document.getElementById('qOnce').value = q.oneTime ? 1 : 0; document.getElementById('qBtn').innerText = "ØªØ­Ø¯ÙŠØ« âœ…"; };
        
        window.svQu = async () => { 
            const id = editingQId || "Q"+Date.now(); 
            const timer = parseInt(document.getElementById('qTime').value);
            const once = parseInt(document.getElementById('qOnce').value) === 1;
            const lecId = document.getElementById('qLec').value;
            const allQs = Object.values(dbData.questions || {}).filter(q => q.lecId === lecId);
            const updates = {};
            allQs.forEach(q => { updates[`academy/questions/${q.id}/timer`] = timer; updates[`academy/questions/${q.id}/oneTime`] = once; });
            await window.update(window.ref(window.db), updates);
            await window.set(window.ref(window.db, 'academy/questions/'+id), { id, lecId, text: document.getElementById('qT').value, a: document.getElementById('qa').value, b: document.getElementById('qb').value, c: document.getElementById('qc').value, d: document.getElementById('qd').value, correct: document.getElementById('qC').value, timer, oneTime: once }); 
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†! âœ…"); admTab('qu'); 
        };

        window.showLecRanks = (id) => { const res = Object.values(dbData.quizResults || {}).filter(r => r.lecId === id).sort((a,b) => b.score - a.score); document.getElementById('lecRanksBox').innerHTML = res.map((r, i) => `<div class="p-4 bg-slate-50 rounded-xl flex justify-between font-bold"><span>${i+1}. ${r.student}</span><span class="text-red-600">${r.score}%</span></div>`).join(''); };
        window.delItem = async (p, id) => { if(confirm("Ø­Ø°ÙØŸ")) { await window.remove(window.ref(window.db, `academy/${p}/${id}`)); alert("ØªÙ…!"); location.reload(); } };
        window.upImg = (i) => { const r = new FileReader(); r.onload = (e) => tempImg = e.target.result; r.readAsDataURL(i.files[0]); };
        window.svCh = async () => { const id = "CH"+Date.now(); await window.set(window.ref(window.db, 'academy/chapters/'+id), { id, title: document.getElementById('at').value, price: document.getElementById('ap').value, level: document.getElementById('al').value, img: tempImg }); admTab('ch'); };
        window.svLe = async () => { const id = "L"+Date.now(); await window.set(window.ref(window.db, 'academy/lectures/'+id), { id, chId: document.getElementById('lch').value, title: document.getElementById('lt').value, url: document.getElementById('lu').value }); admTab('le'); };
        window.genTurbo = async () => { const amt = document.getElementById('camt').value; const total = parseInt(document.getElementById('ccnt').value); let c = 0; const batch = async () => { const ups = {}; for(let i=0; i<200 && c<total; i++) { const code = "KING-"+Math.random().toString(36).substr(2,6).toUpperCase(); ups[`academy/codes/${code}`] = { code, amount: amt, used: false }; c++; } await window.update(window.ref(window.db), ups); if(c < total) setTimeout(batch, 5); else alert("ØªÙ…!"); }; batch(); };
        window.showSection = (id) => { document.querySelectorAll('.sec').forEach(s=>s.classList.remove('active')); document.getElementById(id+'Sec').classList.add('active'); };
        window.openAdmin = () => document.getElementById('adminPanel').classList.remove('hidden');
        window.closeAdmin = () => document.getElementById('adminPanel').classList.add('hidden');
        window.logout = () => { localStorage.clear(); location.reload(); };
        window.useCode = async () => { const c = document.getElementById('cInp').value.trim().toUpperCase(); if(!c) return; const snap = await window.get(window.ref(window.db, 'academy/codes/'+c)); if(snap.exists() && !snap.val().used) { const amt = parseInt(snap.val().amount); await window.update(window.ref(window.db, 'academy/students/'+user.phone), { balance: (user.balance || 0) + amt }); await window.update(window.ref(window.db, 'academy/codes/'+c), { used: true }); alert("ØªÙ… Ø§Ù„Ø´Ø­Ù†!"); } else alert("Ø®Ø·Ø£!"); };
        window.buyCourse = async (id, pr) => { if(user.balance >= pr) { if(confirm("Ø´Ø±Ø§Ø¡ØŸ")) { const u = {}; u[`academy/students/${user.phone}/balance`] = user.balance - pr; u[`academy/students/${user.phone}/courses/${id}`] = true; await window.update(window.ref(window.db), u); } } else alert("Ø±ØµÙŠØ¯ Ù†Ø§Ù‚Øµ!"); };
        window.sendMsg = async () => { const i = document.getElementById('msgInp'); if(!i.value) return; await window.push(window.ref(window.db, 'academy/chats'), { name: user.name, phone: user.phone, text: i.value, level: user.level, time: Date.now() }); i.value = ""; };
        function renderForum() { const b = document.getElementById('chatBox'); const cs = Object.values(dbData.chats || {}).filter(m => user.role === 'admin' || m.level === user.level); b.innerHTML = cs.map(m => `<div class="flex flex-col ${m.phone === user.phone ? 'items-end' : 'items-start'}"><span class="text-[9px] opacity-30">${m.name}</span><div class="p-3 rounded-2xl font-bold ${m.phone === user.phone ? 'bg-red-600 text-white' : 'bg-white shadow-sm'}">${m.text}</div></div>`).join(''); b.scrollTop = b.scrollHeight; }
        function renderRanks() {
            const list = document.getElementById('ranksList'); if(!dbData.quizResults) return;
            const grouped = Object.values(dbData.quizResults).reduce((acc, res) => { if(!acc[res.lecId]) acc[res.lecId] = { title: res.lecTitle, students: [] }; acc[res.lecId].students.push(res); return acc; }, {});
            list.innerHTML = Object.values(grouped).map(lec => {
                const top10 = lec.students.sort((a,b) => b.score - a.score).slice(0, 10);
                return `<div class="royal-card overflow-hidden mb-6"><div class="bg-slate-900 p-4 text-white font-black">${lec.title}</div><div class="p-4">${top10.map((s, i) => `<div class="flex justify-between p-2 border-b"><span>${i+1}. ${s.student}</span><span class="text-red-600">${s.score}%</span></div>`).join('')}</div></div>`;
            }).join('');
        }
    </script>
</body>
</html>
